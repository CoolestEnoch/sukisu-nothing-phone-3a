name: Build SukiSU-Ultra for Noting Phone (3a)

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v2
      with:
        repository: NothingOSS/android_kernel_msm-6.1_nothing_sm7635
    - name: Preparements
      run: |
        pwd
        ls

        sudo apt update && sudo apt upgrade
        sudo apt install -y build-essential git curl wget bison flex zip bc cpio libssl-dev ccache
        # sudo apt install -y git gnupg flex bison gperf build-essential zip curl wget zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc unzip bc

        echo "[+] Append kernel params to kprobes"
        echo "CONFIG_KPM=y" >> arch/arm64/configs/gki_defconfig

        echo "[+] Patch with SukiSU-Ultra"
        # curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main

        echo "[+] Done."

        wget https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.zip
        unzip 20210522.zip
        rm 20210522.zip
        mv proton-clang-20210522 ../proton-clang-20210522
        export PATH=/home/runner/work/sukisu-nothing-phone-3a/proton-clang-20210522/bin:$PATH
        mkdir ../ccache
        export CCACHE_DIR="/home/runner/work/sukisu-nothing-phone-3a/ccache" 
        export CC="ccache gcc"
        export CXX="ccache g++"
        MAKE_ARGS="ARCH=arm64 SUBARCH=arm64 O=out CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-"

        make $MAKE_ARGS gki_defconfig
        make $MAKE_ARGS -j$(nproc)
    
    - name: Upload Build
      uses: actions/upload-artifact@v4
      with:
        name: Image
        path: /home/runner/work/sukisu-nothing-phone-3a/sukisu-nothing-phone-3a/arch/arm64/boot/Image
        if-no-files-found: warn
        retention-days: 30

